<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Openclaw セットアップ</title>
  <link rel="stylesheet" href="/setup/styles.css" />
</head>
<body>
  <h1>Openclaw セットアップ</h1>
  <p class="muted">このウィザードは、ターミナルで実行するのと同じオンボーディングコマンドをブラウザから実行してOpenclawを設定します。</p>

  <div class="card">
    <h2>ステータス</h2>
    <div id="status">読み込み中...</div>
    <div id="statusDetails" style="margin-top: 0.75rem; padding: 0.75rem; background: #f5f5f5; border-radius: 4px;"></div>
    <div style="margin-top: 0.75rem">
      <a href="/openclaw" target="_blank">Openclaw UIを開く</a>
      &nbsp;|&nbsp;
      <a href="/setup/export" target="_blank">バックアップをダウンロード（.tar.gz）</a>
      &nbsp;|&nbsp;
      <a href="/healthz" target="_blank">ヘルスチェック</a>
    </div>
    <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #ddd;">
      <p class="muted" style="margin: 0;">
        貢献したいですか？ <a href="https://github.com/moltinginstar/moltbot/blob/main/CONTRIBUTING.md" target="_blank">コントリビューティングガイド</a>をご覧ください。
      </p>
    </div>

    <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #ddd;">
      <h3 style="margin-top: 0; font-size: 1rem;">バックアップのインポート</h3>
      <p class="muted">以前のバックアップから設定とワークスペースを復元します。既存のデータは上書きされます。</p>

      <label>バックアップファイル（.tar.gz）</label>
      <input id="importFile" type="file" accept=".tar.gz,.tgz,application/gzip,application/x-gzip" />

      <button id="importButton">バックアップをインポート</button>
      <pre id="importOutput" style="margin-top: 1rem; max-height: 200px; overflow-y: auto; background: #f5f5f5; padding: 0.75rem; border-radius: 4px;"></pre>
    </div>
  </div>

  <div class="card">
    <h2>デバッグコンソール</h2>
    <p class="muted">SSHアクセスなしでOpenClawコマンドを実行します。すべてのコマンドはセキュリティのために許可リストに登録されています。</p>

    <label>コマンド</label>
    <select id="consoleCommand">
      <option value="">-- コマンドを選択 --</option>
      <optgroup label="ゲートウェイライフサイクル">
        <option value="gateway.restart">gateway.restart - ゲートウェイプロセスを再起動</option>
        <option value="gateway.stop">gateway.stop - ゲートウェイプロセスを停止</option>
        <option value="gateway.start">gateway.start - ゲートウェイプロセスを開始</option>
      </optgroup>
      <optgroup label="OpenClawステータス">
        <option value="openclaw.version">openclaw.version - OpenClawバージョンを表示</option>
        <option value="openclaw.status">openclaw.status - ゲートウェイステータスを表示</option>
        <option value="openclaw.health">openclaw.health - ヘルスチェックを実行</option>
        <option value="openclaw.doctor">openclaw.doctor - 診断を実行</option>
      </optgroup>
      <optgroup label="ログと設定">
        <option value="openclaw.logs.tail">openclaw.logs.tail - 最近のログを表示（引数：件数）</option>
        <option value="openclaw.config.get">openclaw.config.get - 設定値を取得（引数：パス）</option>
      </optgroup>
      <optgroup label="デバイス">
        <option value="openclaw.devices.list">openclaw.devices.list - デバイス一覧を表示</option>
        <option value="openclaw.devices.approve">openclaw.devices.approve - デバイスを承認（引数：requestId）</option>
      </optgroup>
      <optgroup label="プラグイン">
        <option value="openclaw.plugins.list">openclaw.plugins.list - プラグイン一覧を表示</option>
        <option value="openclaw.plugins.enable">openclaw.plugins.enable - プラグインを有効化（引数：名前）</option>
      </optgroup>
    </select>

    <label>引数（必要な場合）</label>
    <input id="consoleArg" type="text" placeholder="例：ログ件数には50、設定パスにはgateway.port、デバイス承認にはrequestId" />
    <div class="muted" style="margin-top: 0.25rem">
      一部のコマンドには引数が必要です：ログ件数（件数）、設定取得（パス）、デバイス承認（requestId）、プラグイン有効化（名前）。
    </div>

    <button id="consoleRun">コマンドを実行</button>
    <pre id="consoleOutput" style="margin-top: 1rem; max-height: 400px; overflow-y: auto; background: #f5f5f5; padding: 0.75rem; border-radius: 4px;"></pre>
  </div>

  <div class="card">
    <h2>設定エディター</h2>
    <p class="muted">openclaw.jsonを直接編集します。保存前に自動バックアップが作成されます。保存後にゲートウェイは自動的に再起動します。</p>

    <div class="muted" style="margin-bottom: 0.5rem">
      設定ファイル：<code id="configPath">読み込み中...</code>
    </div>

    <label>JSON設定</label>
    <textarea id="configContent" style="font-family: 'Monaco', 'Menlo', 'Consolas', monospace; font-size: 12px; height: 260px; resize: vertical;"></textarea>

    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
      <button id="configReload">ディスクから再読み込み</button>
      <button id="configSave">保存してゲートウェイを再起動</button>
    </div>

    <pre id="configOutput" style="margin-top: 1rem; max-height: 200px; overflow-y: auto; background: #f5f5f5; padding: 0.75rem; border-radius: 4px;"></pre>
  </div>

  <div class="card">
    <h2>1) モデル/認証プロバイダー</h2>
    <p class="muted">ターミナルのオンボーディングで表示されるグループと対応しています。</p>
    <label>プロバイダーグループ</label>
    <select id="authGroup">
      <option value="">プロバイダーグループを選択...</option>
    </select>

    <label>認証方式</label>
    <select id="authChoice">
      <option value="">認証方式を選択...</option>
    </select>

    <label>キー / トークン（必要な場合）</label>
    <input id="authSecret" type="password" placeholder="APIキー / トークンを貼り付け（該当する場合）" />

    <label>ウィザードフロー</label>
    <select id="flow">
      <option value="quickstart">quickstart</option>
      <option value="advanced">advanced</option>
      <option value="manual">manual</option>
    </select>
  </div>

  <div class="card">
    <h2>2) オプション：チャンネル</h2>
    <p class="muted">チャンネルはOpenclawの中で後から追加することもできますが、ここで設定するとすぐにメッセージングが使えるようになります。</p>

    <label>Telegramボットトークン（オプション）</label>
    <input id="telegramToken" type="password" placeholder="123456:ABC..." />
    <div class="muted" style="margin-top: 0.25rem">
      BotFatherから取得：Telegramを開いて <code>@BotFather</code> にメッセージを送り、<code>/newbot</code> を実行してトークンをコピーします。
    </div>

    <label>Discordボットトークン（オプション）</label>
    <input id="discordToken" type="password" placeholder="Bot token" />
    <div class="muted" style="margin-top: 0.25rem">
      Discord Developer Portalから取得：アプリケーションを作成し、Botを追加して、Botトークンをコピーします。<br/>
      <strong>重要：</strong> Bot → Privileged Gateway Intents で <strong>MESSAGE CONTENT INTENT</strong> を有効にしてください。設定しないとBotが起動時にクラッシュします。
    </div>

    <label>Slackボットトークン（オプション）</label>
    <input id="slackBotToken" type="password" placeholder="xoxb-..." />

    <label>Slackアプリトークン（オプション）</label>
    <input id="slackAppToken" type="password" placeholder="xapp-..." />
  </div>

  <div class="card">
    <h2>2b) 詳細設定：カスタムOpenAI互換プロバイダー（オプション）</h2>
    <p class="muted">OpenAI互換APIを使用するカスタムプロバイダーを追加します（例：ローカルLLM、プロキシサービス）。このプロバイダーは組み込みプロバイダーとマージされます。</p>

    <label>プロバイダーID</label>
    <input id="customProviderId" type="text" placeholder="my-custom-provider" />
    <div class="muted" style="margin-top: 0.25rem">
      英数字、アンダースコア、ダッシュのみ使用可（例："ollama"、"local-llm"、"my_proxy"）。
    </div>

    <label>ベースURL</label>
    <input id="customProviderBaseUrl" type="text" placeholder="https://api.example.com/v1" />
    <div class="muted" style="margin-top: 0.25rem">
      OpenAI互換のため <code>/v1</code> サフィックスを含める必要があります（例："http://localhost:11434/v1"）。
    </div>

    <label>APIタイプ</label>
    <select id="customProviderApi">
      <option value="">-- APIタイプを選択 --</option>
      <option value="openai-completions">openai-completions</option>
      <option value="openai-responses">openai-responses</option>
    </select>

    <label>APIキー環境変数（オプション）</label>
    <input id="customProviderApiKeyEnv" type="text" placeholder="MY_PROVIDER_API_KEY" />
    <div class="muted" style="margin-top: 0.25rem">
      APIキーを含む環境変数名（例："OLLAMA_API_KEY"）。大文字とアンダースコアを使用してください。認証不要のプロバイダーは空白のままにしてください。
    </div>

    <label>モデルID（オプション）</label>
    <input id="customProviderModelId" type="text" placeholder="llama3.2" />
    <div class="muted" style="margin-top: 0.25rem">
      このプロバイダーで使用するデフォルトモデル（例："llama3.2"、"gpt-4"）。後から変更可能です。
    </div>
  </div>

  <div class="card">
    <h2>3) オンボーディングを実行</h2>
    <button id="run">セットアップを実行</button>
    <button id="pairingApprove" class="secondary-button">ペアリングを承認</button>
    <button id="reset" class="tertiary-button">セットアップをリセット</button>
    <pre id="log"></pre>
    <p class="muted">リセットするとOpenclawの設定ファイルが削除され、オンボーディングを再実行できます。ペアリング承認はdmPolicy=pairingの場合にDMアクセスを許可します。</p>

    <details style="margin-top: 1rem;">
      <summary style="cursor: pointer; font-weight: bold;">デバイスペアリングヘルパー</summary>
      <div style="margin-top: 0.75rem;">
        <p class="muted">デバイスペアリング認証を使用する場合、保留中のデバイス接続リクエストを承認します。</p>
        <button id="devicesRefresh">保留中のデバイスを更新</button>
        <div id="devicesList" style="margin-top: 0.75rem;"></div>
      </div>
    </details>
  </div>

  <footer style="margin-top: 3rem; padding: 2rem 1rem 1rem; border-top: 2px solid #ddd; text-align: center;">
    <div style="max-width: 600px; margin: 0 auto;">
      <h3 style="margin-top: 0; font-size: 1.1rem;">サポートが必要ですか？</h3>
      <p class="muted" style="margin-bottom: 1rem;">コミュニティとコントリビューターからサポートを受ける</p>
      <div style="display: flex; justify-content: center; gap: 1.5rem; flex-wrap: wrap;">
        <a href="https://github.com/codetitlan/moltbot-railway-template/issues/new" target="_blank" style="text-decoration: none;">
          📝 問題を報告
        </a>
        <a href="https://discord.gg/openclaw" target="_blank" style="text-decoration: none;">
          💬 Discordコミュニティ
        </a>
        <a href="https://github.com/codetitlan/moltbot-railway-template#readme" target="_blank" style="text-decoration: none;">
          📚 ドキュメント
        </a>
      </div>
      <p class="muted" style="margin-top: 1.5rem; font-size: 0.85em;">
        moltbot-railway-template | Powered by <a href="https://github.com/moltinginstar/openclaw" target="_blank">OpenClaw</a>
      </p>
    </div>
  </footer>

  <script src="/setup/app.js"></script>
</body>
</html>
